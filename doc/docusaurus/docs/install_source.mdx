---
id: install_source
title: Install From Source
description: How to build from source
sidebar_label: Install from Source
tags:
  - API
  - CLI
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import DuneCopasiHelp from './DuneCopasiHelp'
import ExampleTerminal from '@site/src/components/ExampleTerminal'

:::caution development
These are the instruction for the development branch of DuneCopasi!
:::

:::tip docker build
This mode of installation is recommended only for [API usage](use_api), immersive developemt,
or cases where upstream dependencies need to be modified. In other cases, you can easily modify
the source code, build it, and use it through a [docker installation](install_docker) without needing
to install the dependencies.
:::

:::note Operating Systems and Compilers
The installation from source is known to compile and run under Debian/Ubuntu, macOS, and Windows.
In all three cases with [Clang](https://clang.llvm.org) and [GCC](https://gcc.gnu.org)
based compilers. It is known to be **not** compatible with Microsoft Visual Studio.
:::

## Dependencies

Locally building and installing DuneCopasi requires a variety of dependencies:

:::caution development branches
Many of these dependencies are in a development branch (e.g., `master`) because DuneCopasi is also under developemt
or because the package does not offer other tagged release.
:::

| Software | Version / `branch` |
| ---------| -------------- |
| [Ninja](https://ninja-build.org) / [Make](https://www.gnu.org/software/make/)               |         |
| [CMake](https://cmake.org/)                                                                 | >= 3.24 |
| C++ compiler  | >= [C++20](https://en.wikipedia.org/wiki/List_of_compilers#C++_compilers)   |
| [pkg-config](https://www.freedesktop.org/wiki/Software/pkg-config)                          | >= 1.8.1|
| [\{fmt\}](https://fmt.dev/)                                                                 | >= 9.1.0 |
| [spdlog](https://github.com/gabime/spdlog)                                                  | >= 1.10.0 |
| [libTIFF](http://www.libtiff.org/)                                                          | >= 3.6.1 |
| [muParser](https://beltoforion.de/article.php?a=muparser) (optional)                        | >= 2.2.5 |
| [SymEngine](https://symengine.org) (optional)                                               | >= 0.8.0 |
| [ExprTk](https://www.partow.net/programming/exprtk) (optional, automatic)                   | >= 0.0.2 |
| [METIS](https://github.com/KarypisLab/METIS) (optional)                                     | >= 5.1.0 |
| [parafields-core](https://github.com/parafields/parafields-core) (optional, automatic)      | `master` |
| [MPI](https://www.mpi-forum.org) (optional)                                                 | >= 3.1   |
| [FFTW](https://www.fftw.org) (optional)                                                     | >= 3.0.0 |
| [TBB](https://oneapi-src.github.io) (optional)                                              | >= 2018.12 |
| [GTest](https://google.github.io) (optional, automatic)                                     | >= 1.12.1 |
| [function2](https://naios.github.io/function2/) (automatic)                                 | >= 4.2.3 |
| [nlohmann::json](https://github.com/nlohmann/json) (automatic)                              | >= 3.11.3 |
| [SuiteSparse](https://people.engr.tamu.edu/davis/suitesparse.html)                          | >= 2.3.3 |
| [Perfetto](https://perfetto.dev)                                                            | >= 32.1 |
| [dune-common](https://gitlab.dune-project.org/core/dune-common)                             | `master` |
| [dune-geometry](https://gitlab.dune-project.org/core/dune-geometry)                         | `master` |
| [dune-grid](https://gitlab.dune-project.org/core/dune-grid)                                 | `master` |
| [dune-uggrid](https://gitlab.dune-project.org/staging/dune-uggrid)                          | `master` |
| [dune-istl](https://gitlab.dune-project.org/core/dune-istl)                                 | `master` |
| [dune-localfunctions](https://gitlab.dune-project.org/core/dune-localfunctions)             | `master` |
| [dune-functions](https://gitlab.dune-project.org/staging/dune-functions)                    | `master` |
| [dune-multidomaingrid](https://gitlab.dune-project.org/extensions/dune-multidomaingrid)     | `master` |
| [dune-typetree](https://gitlab.dune-project.org/staging/dune-typetree)                      | `master` |
| [dune-pdelab](https://gitlab.dune-project.org/pdelab/dune-pdelab)                           | `feature/dune-assembler/main-multithreaded` |

* **automatic**: The requirement is automatically fetched from the internet by CMake.
See the [CMake configuration options](#cmake-configuration-options) on how to enable/disable this feature.
* **optional**: The software package is not mandatory (but recommended) to build DuneCopasi.

:::note MPI and FFTW requirements
The MPI and FFTW packages are only to fulfill the requirements of parafields-core.
If these packages are present if your system, CMake can resolve parafields-core automatically by setting the option
`DUNE_COPASI_DISABLE_FETCH_PACKAGE_parafields` to `OFF` in CMake.
:::

## Install Generic Dependencies

Many of the generic dependencies can be directly obtained by package managers, e.g.,

<Tabs
  groupId="package-manager"
  defaultValue="apt"
  values={[
      {label: 'Debian/Ubuntu (apt)', value: 'apt', },
      {label: 'macOS/Linux (brew)', value: 'brew', },
    ]
  }>

  <TabItem value="apt">

```bash
apt update
apt install \
  cmake \
  g++ \
  gcc \
  git \
  libmuparser-dev \
  libfftw3-dev \
  libfftw3-mpi-dev \
  libgtest-dev \
  libscotchmetis-dev \
  libspdlog-dev \
  libtbb-dev \
  libtiff-dev \
  mpi-default-bin \
  mpi-default-dev \
  ninja-build \
  pkg-config
```

  </TabItem>
  <TabItem value="brew">

```bash
brew update
brew install \
  cmake \
  fftw \
  fmt \
  gcc \
  git \
  libtiff \
  metis \
  muparser \
  ninja \
  open-mpi \
  pkg-config \
  scotch \
  spdlog \
  suite-sparse \
  symengine \
  tbb
```

  </TabItem>
</Tabs>


## Download DUNE modules

:::danger DUNE Version incompatibility
Notice that this procedure assumes that you don't have previous installation of DUNE in
your system. If that's the case, uninstall DUNE before continuing, otherwise, version
conflicts may be difficult if not impossible to resolve!
:::

The required DUNE modules (including DuneCopasi) can be obtained via
internet by using [`git`](https://git-scm.com/). For smooth installation, is
better place all the dune modules within the same directory.

For this, prepare a folder to download and build dune modules (e.g. `~/dune-modules`):

```bash
mkdir ~/dune-modules && cd ~/dune-modules
```

Then, fetch the required dune modules in the working directory:

```bash title="~/dune-modules"
git clone https://gitlab.dune-project.org/core/dune-common
git clone https://gitlab.dune-project.org/core/dune-geometry
git clone https://gitlab.dune-project.org/core/dune-grid
git clone https://gitlab.dune-project.org/staging/dune-uggrid
git clone https://gitlab.dune-project.org/core/dune-istl
git clone https://gitlab.dune-project.org/core/dune-localfunctions
git clone https://gitlab.dune-project.org/staging/dune-functions
git clone https://gitlab.dune-project.org/extensions/dune-multidomaingrid
git clone https://gitlab.dune-project.org/staging/dune-typetree
git clone -b feature/dune-assembler/main-multithreaded https://gitlab.dune-project.org/pdelab/dune-pdelab
git clone https://gitlab.dune-project.org/copasi/dune-copasi
```


## Build and install `dune-copasi`

Once all dune dependencies are in downloaded in the same folder, you can build and install the _all_ of the DUNE modules using cmake:

```bash title="~/dune-modules"
# generate a CMakeLists.txt to set up a super build project
cmake -P dune-common/cmake/scripts/GenerateDuneSuperBuild.cmake

# generate a Ninja configuration in a directory named 'build'
cmake . -G "Ninja Multi-Config" -B build/

# start the actual build (go grab a coffee â˜•)
cmake --build build/ --config Release

# Optional => Test that dune-copasi works as intended: see instructions below

# install built files (customize install path with '--prefix' option, otherwise you may need sudo)
cmake --install build/ --config Release

# remove source and build files from working directory
cd ~ && rm -r ~/dune-modules
```

:::warning Memory usage
The building stage is known to take substantial memory during compilation (varies depending on the compiler).
If your system fails to build due to insufficient memory, try serializing the build process with the `-j {cores}` flag
and disabling some of the features.
:::

For further information on dune module installation process, check out
the [CMake documentation](https://cmake.org/cmake/help/latest/manual/cmake.1.html#generate-a-project-buildsystem)
and the [dune-project web page](https://www.dune-project.org/doc/installation/).

:::info Custom install path
If you use a custom installation path, you may want to add the installed prefix (e.g. `/opt/dune`) binary directory
into your `PATH` environment variable. This will allow to reach the `dune-copasi` executable from anywhere in your terminal.
For example:

<Tabs
  groupId="shell"
  defaultValue="bash"
  values={[
      {label: 'Bash', value: 'bash', },
      {label: 'Zsh', value: 'zsh', },
    ]
  }>

  <TabItem value="bash">

```shell
# include dune binaries into your path
echo "export PATH=/opt/dune/bin:\$PATH" >> $HOME/.bashrc
```

  </TabItem>
  <TabItem value="zsh">

```shell
# include dune binaries into your path
echo "export PATH=/opt/dune/bin:\$PATH" >> $HOME/.zshrc
```

  </TabItem>
</Tabs>

In all usage examples of this documentation we assume that the path containing `dune-copasi` is contained in your `PATH` environment variable.
:::

## Run the program

Once installed, the program `dune-copasi` will be available on the command line and be ready for [CLI usage](use_cli):

<DuneCopasiHelp/>

:::tip[Configuration Options]
For more information on the possible options to successfully run a simulation, make sure to visit the [Command Line Interface](use_cli), the [Configuration Options](param_tree), and the [Tutorials](/tutorials) documentations!
:::


## Advanced

### Build and run tests

To test DuneCopasi, you can build and run the `test` sub-project in the root directory of the repository.
This can be done to test the built project (with prefix set to the build directory, e.g. `~/dune-modules/build/`) or the installed project
(with prefix set to installed path, e.g. `/opt/dune/`). For instance:

```bash title="~/dune-modules"
# generate configuration for the 'dune-copasi/test' sub-project in a directory named 'build-test'
cmake dune-copasi/test -G "Ninja Multi-Config" -B build-test/ -DCMAKE_PREFIX_PATH:PATH=~/dune-modules/build/

# build tests executables
cmake --build build-test/ --config Release

# run automated tests
ctest --test-dir build-test
```

For more information on the options to run the automated tests, visit the [CTest documentation](https://cmake.org/cmake/help/latest/manual/ctest.1.html).

### CMake configuration options

The following is the list of options to customize the build of DuneCopasi using the [CMake cache](https://cmake.org/cmake/help/latest/manual/cmake.1.html#cmdoption-cmake-D).

| `CACHE:TYPE=DEFAULT` | Description |
| ---------| -------------- |
| `DUNE_COPASI_WITH_EXECUTABLE:BOOL=ON`                           | Build dune-copasi executable |
| `DUNE_COPASI_CONCURRENT_ASSEMBLY:BOOL=ON`                       | Build with concurrent assembly. Turn off to reduce memory consumption |
| `DUNE_COPASI_PRECOMPILED_MODE:BOOL=ON`                          | Pre-build a fixed set of class instances |
| `DUNE_COPASI_GRID_DIMENSIONS:STRING="2"`                        | Semi-colon separated list of dimensions to build |
| `DUNE_COPASI_${dim}D_DIFFUSION_REACTION_FEM_ORDERS:STRING="1"`  | Semi-colon separated list of finite element order to compile for dimension `${dim}`|
| `DUNE_COPASI_DISABLE_FETCH_PACKAGE_ExprTk:BOOL=OFF`             | Disable automatic fetch of ExprTk package |
| `DUNE_COPASI_DISABLE_FETCH_PACKAGE_parafields:BOOL=OFF`         | Disable automatic fetch of parafields-core package |
| `DUNE_COPASI_DISABLE_FMT_STYLE:BOOL=OFF`                        | Disable \{fmt\} styling |
| `DUNE_PDELAB_ENABLE_TRACING:BOOL=ON`                            | Enable automatic fetch of perfetto |

To explore more advanced options, we recommend using [`ccmake`](https://cmake.org/cmake/help/latest/manual/ccmake.1.html) on the command line or
the [cmake GUI](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1)) to explore the possible settings in the build directory.

### Dune Options File

Traditionally, build settings in dune projects are set up using the [dune options
file](https://dune-project.org/doc/installation/#storing-flags-in-an-options-file).
In essence, is just a bash script that sets different flags (mainly the flags
for CMake `CMAKE_FLAGS`). We provide a `dune-copasi.opts` file with sensible default
options for the main operating systems. You can find this file in the root directory
of the `dune-copasi` repository.

This file can be executed to show the recommended configuration:

```bash
# show current build configuration options
./dune-copasi/dune-copasi.opts
```

Executing the configuration options will display something similar to this:

<ExampleTerminal prompt="~/dune-modules/dune-copasi$" title="Current build configuration options">
  {[{
      input: "./dune-copasi.opts",
      output: [
        "Installation Prefix:",
        "  /opt/dune",
        "OS Type:",
        "  linux",
        "CMake flags:",
        "  -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS='-fvisibility=hidden -fpic' -DCMAKE_CXX_FLAGS_DEBUG='-O0 -g' -DCMAKE_CXX_FLAGS_RELEASE='-O3 -DNDEBUG' -DCMAKE_CXX_FLAGS_RELWITHDEBINFO='-O2 -g3 -DNDEBUG -fno-omit-frame-pointer' -DCMAKE_CXX_STANDARD=17 -DCMAKE_DISABLE_FIND_PACKAGE_MPI=OFF -DCMAKE_GENERATOR='Unix Makefiles' -DCMAKE_INSTALL_PREFIX=/opt/dune -DCMAKE_PREFIX_PATH='/opt/dune'  -DDUNE_PDELAB_ENABLE_TRACING=ON  ",
        "Make flags:",
        "   ",
      ]
    }
  ]}
</ExampleTerminal>

For more information about the possible options and the dune options file, check out
the dune [installation documentation](https://dune-project.org/doc/installation/)
and its [build system documentation](https://dune-project.org/sphinx/core-2.7/).
