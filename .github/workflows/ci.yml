name: CI Builds

on: push

env:
  BUILD_SHARED_LIBS: 'OFF'
  CMAKE_DISABLE_FIND_PACKAGE_MPI: 'ON'
  CMAKE_DISABLE_FIND_PACKAGE_parafields: 'ON'
  CMAKE_CXX_FLAGS: "'-fvisibility=hidden -D_GLIBCXX_USE_TBB_PAR_BACKEND=0 -DNDEBUG'"
  CMAKE_CXX_COMPILER_LAUNCHER: 'ccache'
  DUNE_COPASI_USE_STATIC_DEPS: 'ON'
  DUNE_COPASI_DISABLE_FETCH_PACKAGE_parafields: 'ON'
  DUNE_COPASI_GRID_DIMENSIONS: '"2;3"'
  DUNE_ENABLE_PYTHONBINDINGS: 'OFF'
  DUNE_PDELAB_ENABLE_TRACING: 'OFF'
  TERM: 'xterm-256color'

jobs:
  ci:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: "ubuntu-20.04"
            shell: "bash"
            install: '/opt/smelibs'
          - os: "macos-13"
            shell: "bash"
            install: '/opt/smelibs'
          - os: "macos-14"
            shell: "bash"
            install: '/opt/smelibs'
          - os: "windows-2022"
            shell: "msys2 {0}"
            install: '/c/smelibs'
    defaults:
      run:
        shell: ${{ matrix.shell }}
    env:
      CMAKE_INSTALL_PREFIX: ${{ matrix.install }}
      CMAKE_PREFIX_PATH: ${{ matrix.install }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - name: Setup compiler toolchain and download static dependencies
        uses: spatial-model-editor/setup-ci@latest
        with:
          sme_deps_common: latest
      - name: Setup dune dependencies
        run: ./.ci/setup_dune $PWD/dune-copasi.opts
      - name: Build and Install
        run: ./.ci/install $PWD/dune-copasi.opts
      - name: Build and run tests
        run: ./.ci/test $PWD/dune-copasi.opts